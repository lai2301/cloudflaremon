name: Debug API Keys

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Debug API_KEYS Secret
        env:
          API_KEYS_SECRET: ${{ secrets.API_KEYS }}
        run: |
          echo "Checking API_KEYS format..."
          
          # Check if secret exists
          if [[ -z "$API_KEYS_SECRET" ]]; then
            echo "❌ API_KEYS secret is not set!"
            exit 1
          fi
          
          # Show length (without exposing value)
          SECRET_LENGTH=$(printf '%s' "$API_KEYS_SECRET" | wc -c)
          echo "Secret length: $SECRET_LENGTH characters"
          
          # Show first and last characters (safe to show)
          FIRST_CHAR=$(printf '%s' "$API_KEYS_SECRET" | head -c 1)
          LAST_CHAR=$(printf '%s' "$API_KEYS_SECRET" | tail -c 1)
          echo "First character: '$FIRST_CHAR' (should be '{')"
          echo "Last character: '$LAST_CHAR' (should be '}')"
          
          # Try to parse it
          echo ""
          echo "Attempting to parse JSON..."
          printf '%s' "$API_KEYS_SECRET" | node -e "
            const fs = require('fs');
            let data = fs.readFileSync(0, 'utf-8');
            console.log('Raw input length:', data.length);
            console.log('First 50 chars:', data.substring(0, 50));
            console.log('Last 50 chars:', data.substring(data.length - 50));
            
            try {
              const parsed = JSON.parse(data);
              console.log('✅ JSON is valid!');
              console.log('Keys found:', Object.keys(parsed));
            } catch(e) {
              console.log('❌ JSON parse error:', e.message);
              console.log('Error at position:', e.message.match(/position (\d+)/)?.[1]);
              
              // Show character at error position
              const pos = parseInt(e.message.match(/position (\d+)/)?.[1] || '0');
              if (pos < data.length) {
                const char = data[pos];
                const charCode = data.charCodeAt(pos);
                console.log('Character at error position:', char, '(code:', charCode + ')');
              }
            }
          "

