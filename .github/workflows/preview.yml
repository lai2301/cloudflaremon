name: Validate Pull Request

on:
  pull_request:
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Configuration
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check config directory structure
        run: |
          echo "Checking config directory structure..."
          
          # Check if config directory exists
          if [ ! -d "config" ]; then
            echo "âŒ config/ directory not found"
            exit 1
          fi
          
          # Check for required config files
          MISSING_FILES=()
          for file in services.json dashboard.json settings.json notifications.json; do
            if [ ! -f "config/$file" ]; then
              MISSING_FILES+=("config/$file")
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -ne 0 ]; then
            echo "âŒ Missing required config files:"
            printf '  - %s\n' "${MISSING_FILES[@]}"
            exit 1
          fi
          
          echo "âœ… All required config files exist"

      - name: Validate config JSON files
        run: |
          echo "Validating configuration files..."
          
          # Validate each config file
          for file in services.json dashboard.json settings.json notifications.json; do
            echo "Checking config/$file..."
            if ! jq empty "config/$file" 2>/dev/null; then
              echo "âŒ config/$file is not valid JSON"
              exit 1
            fi
            echo "âœ… config/$file is valid"
          done
          
          echo ""
          echo "âœ… All configuration files are valid JSON"

      - name: Check KV namespace status
        run: |
          echo "Checking KV namespace status..."
          if grep -q "YOUR_KV_NAMESPACE_ID_HERE" wrangler.toml; then
            echo "âš ï¸  KV namespace not yet configured (placeholder found)"
            echo "âœ… This is OK! The deployment workflow will create it automatically using Terraform."
            echo ""
            echo "ğŸ“ What will happen:"
            echo "  1. Merge this PR"
            echo "  2. Deployment workflow runs automatically"
            echo "  3. Terraform creates KV namespace"
            echo "  4. wrangler.toml gets updated and committed"
            echo "  5. Worker deploys successfully"
          else
            echo "âœ… KV namespace is already configured"
          fi

      - name: Validate wrangler.toml syntax
        run: |
          echo "Validating wrangler.toml syntax..."
          # Just check the file is valid TOML, don't try to deploy
          if ! grep -q "^name = " wrangler.toml; then
            echo "âŒ wrangler.toml appears invalid"
            exit 1
          fi
          if ! grep -q "^main = " wrangler.toml; then
            echo "âŒ wrangler.toml missing 'main' field"
            exit 1
          fi
          echo "âœ… wrangler.toml syntax is valid"

      - name: Check if first-time setup
        id: check_setup
        run: |
          if grep -q "YOUR_KV_NAMESPACE_ID_HERE" wrangler.toml; then
            echo "is_first_time=true" >> $GITHUB_OUTPUT
          else
            echo "is_first_time=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR (First-Time Setup)
        uses: actions/github-script@v8
        if: success() && steps.check_setup.outputs.is_first_time == 'true'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `âœ… Configuration validated successfully!

            **ğŸ‰ First-Time Setup Detected**

            This appears to be your first deployment. Here's what will happen when you merge:

            1. âœ¨ The deployment workflow will automatically run
            2. ğŸ—ï¸ Terraform will create the KV namespace
            3. ğŸ“ \`wrangler.toml\` will be updated with the namespace ID
            4. ğŸ’¾ Changes will be committed automatically
            5. ğŸš€ Your worker will deploy successfully

            **No manual steps required!** Just merge this PR and watch the automation work.

            ğŸ“– [View Deployment Documentation](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/DEPLOYMENT.md)`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

      - name: Comment on PR (Normal)
        uses: actions/github-script@v8
        if: success() && steps.check_setup.outputs.is_first_time == 'false'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Configuration validated successfully! Ready to merge and deploy.'
            })

